<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/demux/adts.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/demux</a> adts.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/84</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/53</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/84</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 *  ADTS parser helper
 */
import { logger } from '../utils/logger';
import { ErrorTypes, ErrorDetails } from '../errors';
&nbsp;
import Event from '../events';
&nbsp;
import { getSelfScope } from '../utils/get-self-scope';
&nbsp;
export function <span class="fstat-no" title="function not covered" >getAudioConfig </span>(observer, data, offset, audioCodec) {
  let adtsObjectType, // :int
    adtsSampleingIndex, // :int
    adtsExtensionSampleingIndex, // :int
    adtsChanelConfig, // :int
    config,
    userAgent = <span class="cstat-no" title="statement not covered" >navigator.userAgent.toLowerCase(),</span>
    manifestCodec = <span class="cstat-no" title="statement not covered" >audioCodec,</span>
    adtsSampleingRates = <span class="cstat-no" title="statement not covered" >[</span>
      96000, 88200,
      64000, 48000,
      44100, 32000,
      24000, 22050,
      16000, 12000,
      11025, 8000,
      7350];
  // byte 2
<span class="cstat-no" title="statement not covered" >  adtsObjectType = ((data[offset + 2] &amp; 0xC0) &gt;&gt;&gt; 6) + 1;</span>
<span class="cstat-no" title="statement not covered" >  adtsSampleingIndex = ((data[offset + 2] &amp; 0x3C) &gt;&gt;&gt; 2);</span>
<span class="cstat-no" title="statement not covered" >  if (adtsSampleingIndex &gt; adtsSampleingRates.length - 1) {</span>
<span class="cstat-no" title="statement not covered" >    observer.trigger(Event.ERROR, { type: ErrorTypes.MEDIA_ERROR, details: ErrorDetails.FRAG_PARSING_ERROR, fatal: true, reason: `invalid ADTS sampling index:${adtsSampleingIndex}` });</span>
<span class="cstat-no" title="statement not covered" >    return;</span>
  }
<span class="cstat-no" title="statement not covered" >  adtsChanelConfig = ((data[offset + 2] &amp; 0x01) &lt;&lt; 2);</span>
  // byte 3
<span class="cstat-no" title="statement not covered" >  adtsChanelConfig |= ((data[offset + 3] &amp; 0xC0) &gt;&gt;&gt; 6);</span>
<span class="cstat-no" title="statement not covered" >  logger.log(`manifest codec:${audioCodec},ADTS data:type:${adtsObjectType},sampleingIndex:${adtsSampleingIndex}[${adtsSampleingRates[adtsSampleingIndex]}Hz],channelConfig:${adtsChanelConfig}`);</span>
  // firefox: freq less than 24kHz = AAC SBR (HE-AAC)
<span class="cstat-no" title="statement not covered" >  if (/firefox/i.test(userAgent)) {</span>
<span class="cstat-no" title="statement not covered" >    if (adtsSampleingIndex &gt;= 6) {</span>
<span class="cstat-no" title="statement not covered" >      adtsObjectType = 5;</span>
<span class="cstat-no" title="statement not covered" >      config = new Array(4);</span>
      // HE-AAC uses SBR (Spectral Band Replication) , high frequencies are constructed from low frequencies
      // there is a factor 2 between frame sample rate and output sample rate
      // multiply frequency by 2 (see table below, equivalent to substract 3)
<span class="cstat-no" title="statement not covered" >      adtsExtensionSampleingIndex = adtsSampleingIndex - 3;</span>
    } else {
<span class="cstat-no" title="statement not covered" >      adtsObjectType = 2;</span>
<span class="cstat-no" title="statement not covered" >      config = new Array(2);</span>
<span class="cstat-no" title="statement not covered" >      adtsExtensionSampleingIndex = adtsSampleingIndex;</span>
    }
    // Android : always use AAC
  } else <span class="cstat-no" title="statement not covered" >if (userAgent.indexOf('android') !== -1) {</span>
<span class="cstat-no" title="statement not covered" >    adtsObjectType = 2;</span>
<span class="cstat-no" title="statement not covered" >    config = new Array(2);</span>
<span class="cstat-no" title="statement not covered" >    adtsExtensionSampleingIndex = adtsSampleingIndex;</span>
  } else {
    /*  for other browsers (Chrome/Vivaldi/Opera ...)
        always force audio type to be HE-AAC SBR, as some browsers do not support audio codec switch properly (like Chrome ...)
    */
<span class="cstat-no" title="statement not covered" >    adtsObjectType = 5;</span>
<span class="cstat-no" title="statement not covered" >    config = new Array(4);</span>
    // if (manifest codec is HE-AAC or HE-AACv2) OR (manifest codec not specified AND frequency less than 24kHz)
<span class="cstat-no" title="statement not covered" >    if ((audioCodec &amp;&amp; ((audioCodec.indexOf('mp4a.40.29') !== -1) ||</span>
      (audioCodec.indexOf('mp4a.40.5') !== -1))) ||
      (!audioCodec &amp;&amp; adtsSampleingIndex &gt;= 6)) {
      // HE-AAC uses SBR (Spectral Band Replication) , high frequencies are constructed from low frequencies
      // there is a factor 2 between frame sample rate and output sample rate
      // multiply frequency by 2 (see table below, equivalent to substract 3)
<span class="cstat-no" title="statement not covered" >      adtsExtensionSampleingIndex = adtsSampleingIndex - 3;</span>
    } else {
      // if (manifest codec is AAC) AND (frequency less than 24kHz AND nb channel is 1) OR (manifest codec not specified and mono audio)
      // Chrome fails to play back with low frequency AAC LC mono when initialized with HE-AAC.  This is not a problem with stereo.
<span class="cstat-no" title="statement not covered" >      if (audioCodec &amp;&amp; audioCodec.indexOf('mp4a.40.2') !== -1 &amp;&amp; ((adtsSampleingIndex &gt;= 6 &amp;&amp; adtsChanelConfig === 1) ||</span>
            /vivaldi/i.test(userAgent)) ||
        (!audioCodec &amp;&amp; adtsChanelConfig === 1)) {
<span class="cstat-no" title="statement not covered" >        adtsObjectType = 2;</span>
<span class="cstat-no" title="statement not covered" >        config = new Array(2);</span>
      }
<span class="cstat-no" title="statement not covered" >      adtsExtensionSampleingIndex = adtsSampleingIndex;</span>
    }
  }
  /* refer to http://wiki.multimedia.cx/index.php?title=MPEG-4_Audio#Audio_Specific_Config
      ISO 14496-3 (AAC).pdf - Table 1.13 — Syntax of AudioSpecificConfig()
    Audio Profile / Audio Object Type
    0: Null
    1: AAC Main
    2: AAC LC (Low Complexity)
    3: AAC SSR (Scalable Sample Rate)
    4: AAC LTP (Long Term Prediction)
    5: SBR (Spectral Band Replication)
    6: AAC Scalable
   sampling freq
    0: 96000 Hz
    1: 88200 Hz
    2: 64000 Hz
    3: 48000 Hz
    4: 44100 Hz
    5: 32000 Hz
    6: 24000 Hz
    7: 22050 Hz
    8: 16000 Hz
    9: 12000 Hz
    10: 11025 Hz
    11: 8000 Hz
    12: 7350 Hz
    13: Reserved
    14: Reserved
    15: frequency is written explictly
    Channel Configurations
    These are the channel configurations:
    0: Defined in AOT Specifc Config
    1: 1 channel: front-center
    2: 2 channels: front-left, front-right
  */
  // audioObjectType = profile =&gt; profile, the MPEG-4 Audio Object Type minus 1
<span class="cstat-no" title="statement not covered" >  config[0] = adtsObjectType &lt;&lt; 3;</span>
  // samplingFrequencyIndex
<span class="cstat-no" title="statement not covered" >  config[0] |= (adtsSampleingIndex &amp; 0x0E) &gt;&gt; 1;</span>
<span class="cstat-no" title="statement not covered" >  config[1] |= (adtsSampleingIndex &amp; 0x01) &lt;&lt; 7;</span>
  // channelConfiguration
<span class="cstat-no" title="statement not covered" >  config[1] |= adtsChanelConfig &lt;&lt; 3;</span>
<span class="cstat-no" title="statement not covered" >  if (adtsObjectType === 5) {</span>
    // adtsExtensionSampleingIndex
<span class="cstat-no" title="statement not covered" >    config[1] |= (adtsExtensionSampleingIndex &amp; 0x0E) &gt;&gt; 1;</span>
<span class="cstat-no" title="statement not covered" >    config[2] = (adtsExtensionSampleingIndex &amp; 0x01) &lt;&lt; 7;</span>
    // adtsObjectType (force to 2, chrome is checking that object type is less than 5 ???
    //    https://chromium.googlesource.com/chromium/src.git/+/master/media/formats/mp4/aac.cc
<span class="cstat-no" title="statement not covered" >    config[2] |= 2 &lt;&lt; 2;</span>
<span class="cstat-no" title="statement not covered" >    config[3] = 0;</span>
  }
<span class="cstat-no" title="statement not covered" >  return { config: config, samplerate: adtsSampleingRates[adtsSampleingIndex], channelCount: adtsChanelConfig, codec: ('mp4a.40.' + adtsObjectType), manifestCodec: manifestCodec };</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >isHeaderPattern </span>(data, offset) {
<span class="cstat-no" title="statement not covered" >  return data[offset] === 0xff &amp;&amp; (data[offset + 1] &amp; 0xf6) === 0xf0;</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >getHeaderLength </span>(data, offset) {
<span class="cstat-no" title="statement not covered" >  return (data[offset + 1] &amp; 0x01 ? 7 : 9);</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >getFullFrameLength </span>(data, offset) {
<span class="cstat-no" title="statement not covered" >  return ((data[offset + 3] &amp; 0x03) &lt;&lt; 11) |</span>
    (data[offset + 4] &lt;&lt; 3) |
    ((data[offset + 5] &amp; 0xE0) &gt;&gt;&gt; 5);
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >isHeader </span>(data, offset) {
  // Look for ADTS header | 1111 1111 | 1111 X00X | where X can be either 0 or 1
  // Layer bits (position 14 and 15) in header should be always 0 for ADTS
  // More info https://wiki.multimedia.cx/index.php?title=ADTS
<span class="cstat-no" title="statement not covered" >  if (offset + 1 &lt; data.length &amp;&amp; isHeaderPattern(data, offset)) {</span>
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return false;</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >probe </span>(data, offset) {
  // same as isHeader but we also check that ADTS frame follows last ADTS frame
  // or end of data is reached
<span class="cstat-no" title="statement not covered" >  if (offset + 1 &lt; data.length &amp;&amp; isHeaderPattern(data, offset)) {</span>
    // ADTS header Length
    let headerLength = <span class="cstat-no" title="statement not covered" >getHeaderLength(data, offset);</span>
    // ADTS frame Length
    let frameLength = <span class="cstat-no" title="statement not covered" >headerLength;</span>
<span class="cstat-no" title="statement not covered" >    if (offset + 5 &lt; data.length) {</span>
<span class="cstat-no" title="statement not covered" >      frameLength = getFullFrameLength(data, offset);</span>
    }
&nbsp;
    let newOffset = <span class="cstat-no" title="statement not covered" >offset + frameLength;</span>
<span class="cstat-no" title="statement not covered" >    if (newOffset === data.length || (newOffset + 1 &lt; data.length &amp;&amp; isHeaderPattern(data, newOffset))) {</span>
<span class="cstat-no" title="statement not covered" >      return true;</span>
    }
  }
<span class="cstat-no" title="statement not covered" >  return false;</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >initTrackConfig </span>(track, observer, data, offset, audioCodec) {
<span class="cstat-no" title="statement not covered" >  if (!track.samplerate) {</span>
    let config = <span class="cstat-no" title="statement not covered" >getAudioConfig(observer, data, offset, audioCodec);</span>
<span class="cstat-no" title="statement not covered" >    track.config = config.config;</span>
<span class="cstat-no" title="statement not covered" >    track.samplerate = config.samplerate;</span>
<span class="cstat-no" title="statement not covered" >    track.channelCount = config.channelCount;</span>
<span class="cstat-no" title="statement not covered" >    track.codec = config.codec;</span>
<span class="cstat-no" title="statement not covered" >    track.manifestCodec = config.manifestCodec;</span>
<span class="cstat-no" title="statement not covered" >    logger.log(`parsed codec:${track.codec},rate:${config.samplerate},nb channel:${config.channelCount}`);</span>
  }
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >getFrameDuration </span>(samplerate) {
<span class="cstat-no" title="statement not covered" >  return 1024 * 90000 / samplerate;</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >parseFrameHeader </span>(data, offset, pts, frameIndex, frameDuration) {
  let headerLength, frameLength, stamp;
  let length = <span class="cstat-no" title="statement not covered" >data.length;</span>
&nbsp;
  // The protection skip bit tells us if we have 2 bytes of CRC data at the end of the ADTS header
<span class="cstat-no" title="statement not covered" >  headerLength = getHeaderLength(data, offset);</span>
  // retrieve frame size
<span class="cstat-no" title="statement not covered" >  frameLength = getFullFrameLength(data, offset);</span>
<span class="cstat-no" title="statement not covered" >  frameLength -= headerLength;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if ((frameLength &gt; 0) &amp;&amp; ((offset + headerLength + frameLength) &lt;= length)) {</span>
<span class="cstat-no" title="statement not covered" >    stamp = pts + frameIndex * frameDuration;</span>
    // logger.log(`AAC frame, offset/length/total/pts:${offset+headerLength}/${frameLength}/${data.byteLength}/${(stamp/90).toFixed(0)}`);
<span class="cstat-no" title="statement not covered" >    return { headerLength, frameLength, stamp };</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return undefined;</span>
}
&nbsp;
export function <span class="fstat-no" title="function not covered" >appendFrame </span>(track, data, offset, pts, frameIndex) {
  let frameDuration = <span class="cstat-no" title="statement not covered" >getFrameDuration(track.samplerate);</span>
  let header = <span class="cstat-no" title="statement not covered" >parseFrameHeader(data, offset, pts, frameIndex, frameDuration);</span>
<span class="cstat-no" title="statement not covered" >  if (header) {</span>
    let stamp = <span class="cstat-no" title="statement not covered" >header.stamp;</span>
    let headerLength = <span class="cstat-no" title="statement not covered" >header.headerLength;</span>
    let frameLength = <span class="cstat-no" title="statement not covered" >header.frameLength;</span>
&nbsp;
    // logger.log(`AAC frame, offset/length/total/pts:${offset+headerLength}/${frameLength}/${data.byteLength}/${(stamp/90).toFixed(0)}`);
    let aacSample = <span class="cstat-no" title="statement not covered" >{</span>
      unit: data.subarray(offset + headerLength, offset + headerLength + frameLength),
      pts: stamp,
      dts: stamp
    };
&nbsp;
<span class="cstat-no" title="statement not covered" >    track.samples.push(aacSample);</span>
<span class="cstat-no" title="statement not covered" >    track.len += frameLength;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return { sample: aacSample, length: frameLength + headerLength };</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return undefined;</span>
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Mar 14 2019 14:57:18 GMT+0000 (Coordinated Universal Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
