<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/controller/base-stream-controller.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/controller</a> base-stream-controller.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">33.96% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>18/53</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">26.83% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>11/41</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">62.5% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">33.96% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>18/53</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import TaskLoop from '../task-loop';
import { FragmentState } from './fragment-tracker';
import { BufferHelper } from '../utils/buffer-helper';
import { logger } from '../utils/logger';
&nbsp;
export const State = {
  STOPPED: 'STOPPED',
  STARTING: 'STARTING',
  IDLE: 'IDLE',
  PAUSED: 'PAUSED',
  KEY_LOADING: 'KEY_LOADING',
  FRAG_LOADING: 'FRAG_LOADING',
  FRAG_LOADING_WAITING_RETRY: 'FRAG_LOADING_WAITING_RETRY',
  WAITING_TRACK: 'WAITING_TRACK',
  PARSING: 'PARSING',
  PARSED: 'PARSED',
  BUFFER_FLUSHING: 'BUFFER_FLUSHING',
  ENDED: 'ENDED',
  ERROR: 'ERROR',
  WAITING_INIT_PTS: 'WAITING_INIT_PTS',
  WAITING_LEVEL: 'WAITING_LEVEL'
};
&nbsp;
export default class BaseStreamController extends TaskLoop {
<span class="fstat-no" title="function not covered" >  do</span>Tick () {}
&nbsp;
  startLoad () {}
&nbsp;
  stopLoad () {
    let frag = this.fragCurrent;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (frag) {
<span class="cstat-no" title="statement not covered" >      if (frag.loader) {</span>
<span class="cstat-no" title="statement not covered" >        frag.loader.abort();</span>
      }
<span class="cstat-no" title="statement not covered" >      this.fragmentTracker.removeFragment(frag);</span>
    }
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.demuxer) {
<span class="cstat-no" title="statement not covered" >      this.demuxer.destroy();</span>
<span class="cstat-no" title="statement not covered" >      this.demuxer = null;</span>
    }
    this.fragCurrent = null;
    this.fragPrevious = null;
    this.clearInterval();
    this.clearNextTick();
    this.state = State.STOPPED;
  }
&nbsp;
  _streamEnded (bufferInfo, levelDetails) {
    const { fragCurrent, fragmentTracker } = this;
    // we just got done loading the final fragment and there is no other buffered range after ...
    // rationale is that in case there are any buffered ranges after, it means that there are unbuffered portion in between
    // so we should not switch to ENDED in that case, to be able to buffer them
    // dont switch to ENDED if we need to backtrack last fragment
    if (!levelDetails.live &amp;&amp; fragCurrent &amp;&amp; !fragCurrent.backtracked &amp;&amp; fragCurrent.sn === levelDetails.endSN &amp;&amp; !bufferInfo.nextStart) {
      const fragState = fragmentTracker.getState(fragCurrent);
      return fragState === FragmentState.PARTIAL || fragState === FragmentState.OK;
    }
    return false;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  on</span>MediaSeeking () {
    const { config, media, mediaBuffer, state } = <span class="cstat-no" title="statement not covered" >this;</span>
    const currentTime = <span class="cstat-no" title="statement not covered" >media ? media.currentTime : null;</span>
    const bufferInfo = <span class="cstat-no" title="statement not covered" >BufferHelper.bufferInfo(mediaBuffer || media, currentTime, this.config.maxBufferHole);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (Number.isFinite(currentTime)) {</span>
<span class="cstat-no" title="statement not covered" >      logger.log(`media seeking to ${currentTime.toFixed(3)}`);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (state === State.FRAG_LOADING) {</span>
      let fragCurrent = <span class="cstat-no" title="statement not covered" >this.fragCurrent;</span>
      // check if we are seeking to a unbuffered area AND if frag loading is in progress
<span class="cstat-no" title="statement not covered" >      if (bufferInfo.len === 0 &amp;&amp; fragCurrent) {</span>
        const tolerance = <span class="cstat-no" title="statement not covered" >config.maxFragLookUpTolerance;</span>
        const fragStartOffset = <span class="cstat-no" title="statement not covered" >fragCurrent.start - tolerance;</span>
        const fragEndOffset = <span class="cstat-no" title="statement not covered" >fragCurrent.start + fragCurrent.duration + tolerance;</span>
        // check if we seek position will be out of currently loaded frag range : if out cancel frag load, if in, don't do anything
<span class="cstat-no" title="statement not covered" >        if (currentTime &lt; fragStartOffset || currentTime &gt; fragEndOffset) {</span>
<span class="cstat-no" title="statement not covered" >          if (fragCurrent.loader) {</span>
<span class="cstat-no" title="statement not covered" >            logger.log('seeking outside of buffer while fragment load in progress, cancel fragment load');</span>
<span class="cstat-no" title="statement not covered" >            fragCurrent.loader.abort();</span>
          }
<span class="cstat-no" title="statement not covered" >          this.fragCurrent = null;</span>
<span class="cstat-no" title="statement not covered" >          this.fragPrevious = null;</span>
          // switch to IDLE state to load new fragment
<span class="cstat-no" title="statement not covered" >          this.state = State.IDLE;</span>
        } else {
<span class="cstat-no" title="statement not covered" >          logger.log('seeking outside of buffer but within currently loaded fragment range');</span>
        }
      }
    } else <span class="cstat-no" title="statement not covered" >if (state === State.ENDED) {</span>
      // if seeking to unbuffered area, clean up fragPrevious
<span class="cstat-no" title="statement not covered" >      if (bufferInfo.len === 0) {</span>
<span class="cstat-no" title="statement not covered" >        this.fragPrevious = null;</span>
<span class="cstat-no" title="statement not covered" >        this.fragCurrent = null;</span>
      }
&nbsp;
      // switch to IDLE state to check for potential new fragment
<span class="cstat-no" title="statement not covered" >      this.state = State.IDLE;</span>
    }
<span class="cstat-no" title="statement not covered" >    if (media) {</span>
<span class="cstat-no" title="statement not covered" >      this.lastCurrentTime = currentTime;</span>
    }
&nbsp;
    // in case seeking occurs although no media buffered, adjust startPosition and nextLoadPosition to seek target
<span class="cstat-no" title="statement not covered" >    if (!this.loadedmetadata) {</span>
<span class="cstat-no" title="statement not covered" >      this.nextLoadPosition = this.startPosition = currentTime;</span>
    }
&nbsp;
    // tick to speed up processing
<span class="cstat-no" title="statement not covered" >    this.tick();</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  on</span>MediaEnded () {
    // reset startPosition and lastCurrentTime to restart playback @ stream beginning
<span class="cstat-no" title="statement not covered" >    this.startPosition = this.lastCurrentTime = 0;</span>
  }
&nbsp;
  onHandlerDestroying () {
    this.stopLoad();
    super.onHandlerDestroying();
  }
&nbsp;
  onHandlerDestroyed () {
    this.state = State.STOPPED;
    this.fragmentTracker = null;
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Mar 14 2019 14:57:18 GMT+0000 (Coordinated Universal Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
